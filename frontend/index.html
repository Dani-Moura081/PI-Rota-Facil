<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rota Certa - Sistema Financeiro</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --primary-light: #818cf8;
      --success: #047857;
      --success-light: #d1fae5;
      --danger: #b91c1c;
      --danger-light: #fee2e2;
      --warning: #b45309;
      --warning-light: #fef3c7;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--gray-100);
      color: var(--gray-800);
      min-height: 100vh;
      line-height: 1.5;
    }

    #login {
      min-height: 100vh;
      display: flex;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .login-left {
      flex: 1;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: white;
    }

    .login-left h1 {
      font-size: 3rem;
      font-weight: 700;
      margin-bottom: 16px;
    }

    .login-left p {
      font-size: 1.125rem;
      opacity: 0.9;
      max-width: 400px;
    }

    .login-right {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .login-card {
      background: white;
      border-radius: 24px;
      padding: 40px;
      width: 100%;
      max-width: 420px;
      box-shadow: var(--shadow-xl);
    }

    .login-logo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 32px;
    }

    .login-logo-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .login-logo-icon svg {
      width: 28px;
      height: 28px;
      color: white;
    }

    .login-logo h1 {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--gray-900);
    }

    .login-title {
      text-align: center;
      margin-bottom: 32px;
    }

    .login-title h2 {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 8px;
    }

    .login-title p {
      color: var(--gray-500);
      font-size: 0.938rem;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-700);
      margin-bottom: 6px;
    }

    .input-wrapper {
      position: relative;
    }

    .input-wrapper svg {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      color: var(--gray-400);
    }

    .form-input {
      width: 100%;
      padding: 12px 14px 12px 44px;
      border: 1px solid var(--gray-300);
      border-radius: 12px;
      font-size: 0.938rem;
      transition: all 0.2s;
      background: var(--gray-50);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      background: white;
    }

    .form-input::placeholder {
      color: var(--gray-400);
    }

    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 24px;
    }

    .checkbox-wrapper input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
      cursor: pointer;
    }

    .checkbox-wrapper label {
      font-size: 0.875rem;
      color: var(--gray-600);
      cursor: pointer;
    }

    .btn {
      width: 100%;
      padding: 14px 24px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
      color: white;
    }

    .btn-success:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }

    .btn-danger {
      background: var(--gray-100);
      color: var(--danger);
      border: 1px solid var(--gray-200);
    }

    .btn-danger:hover {
      background: var(--danger-light);
    }

    .forgot-link {
      text-align: center;
      margin-top: 20px;
    }

    .forgot-link a {
      color: var(--primary);
      text-decoration: none;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .forgot-link a:hover {
      text-decoration: underline;
    }

    #app {
      display: none;
      min-height: 100vh;
      background: var(--gray-100);
    }

    .app-header {
      background: white;
      padding: 16px 24px;
      box-shadow: var(--shadow-sm);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .header-logo-icon svg {
      width: 24px;
      height: 24px;
      color: white;
    }

    .header-logo span {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--gray-900);
    }

    .header-user {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }

    .btn-logout {
      padding: 10px 16px;
      background: var(--gray-100);
      border: 1px solid var(--gray-200);
      border-radius: 10px;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-600);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-logout:hover {
      background: var(--gray-200);
    }

    .btn-logout svg {
      width: 18px;
      height: 18px;
    }

    .app-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .summary-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow);
    }

    .summary-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .summary-card-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .summary-card-icon svg {
      width: 24px;
      height: 24px;
    }

    .summary-card-icon.green {
      background: var(--success-light);
      color: var(--success);
    }

    .summary-card-icon.red {
      background: var(--danger-light);
      color: var(--danger);
    }

    .summary-card-icon.blue {
      background: rgba(99, 102, 241, 0.1);
      color: var(--primary);
    }

    .summary-card-title {
      font-size: 0.875rem;
      color: var(--gray-500);
      font-weight: 500;
    }

    .summary-card-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--gray-900);
    }

    .summary-card-value.positive {
      color: var(--success);
    }

    .summary-card-value.negative {
      color: var(--danger);
    }

    .summary-card-change {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.813rem;
      margin-top: 8px;
    }

    .summary-card-change.up {
      color: var(--success);
    }

    .summary-card-change.down {
      color: var(--danger);
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      background: white;
      padding: 6px;
      border-radius: 14px;
      box-shadow: var(--shadow-sm);
    }

    .tab-btn {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      font-size: 0.938rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      background: transparent;
      color: var(--gray-500);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .tab-btn svg {
      width: 20px;
      height: 20px;
    }

    .tab-btn.active {
      background: var(--primary);
      color: white;
    }

    .tab-btn:not(.active):hover {
      background: var(--gray-100);
      color: var(--gray-700);
    }

    .card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow);
    }

    .card-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-title svg {
      width: 24px;
      height: 24px;
      color: var(--primary);
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .form-input-simple {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--gray-300);
      border-radius: 12px;
      font-size: 0.938rem;
      transition: all 0.2s;
      background: var(--gray-50);
    }

    .form-input-simple:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      background: white;
    }

    select.form-input-simple {
      cursor: pointer;
    }

    .hidden {
      display: none !important;
    }

    .timeline {
      margin-top: 20px;
    }

    .timeline-item {
      display: flex;
      gap: 16px;
      padding: 16px;
      background: var(--gray-50);
      border-radius: 12px;
      margin-bottom: 12px;
      transition: all 0.2s;
      border: 1px solid transparent;
    }

    .timeline-item:hover {
      border-color: var(--gray-200);
      background: white;
    }

    .timeline-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .timeline-icon.venda {
      background: var(--success-light);
      color: var(--success);
    }

    .timeline-icon.coleta {
      background: var(--warning-light);
      color: var(--warning);
    }

    .timeline-icon svg {
      width: 24px;
      height: 24px;
    }

    .timeline-content {
      flex: 1;
    }

    .timeline-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .timeline-title {
      font-weight: 600;
      color: var(--gray-900);
    }

    .timeline-date {
      font-size: 0.813rem;
      color: var(--gray-500);
    }

    .timeline-location {
      font-size: 0.875rem;
      color: var(--gray-600);
      margin-bottom: 8px;
    }

    .timeline-values {
      display: flex;
      gap: 16px;
      font-size: 0.875rem;
    }

    .timeline-value {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .timeline-value.expense {
      color: var(--danger);
    }

    .timeline-value.income {
      color: var(--success);
    }

    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--gray-500);
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      color: var(--gray-300);
    }

    .empty-state h3 {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 8px;
    }

    @media (min-width: 768px) {
      .login-left {
        display: flex;
      }

      .login-right {
        flex: none;
        width: 480px;
      }
    }

    @media (max-width: 640px) {
      .summary-cards {
        grid-template-columns: 1fr;
      }

      .app-content {
        padding: 16px;
      }

      .header-user span {
        display: none;
      }

      .form-row {
        grid-template-columns: 1fr;
      }
    }

    .cep-wrapper {
      position: relative;
    }

    .cep-status {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.75rem;
      font-weight: 500;
    }

    .cep-status.loading {
      color: var(--primary);
    }

    .cep-status.success {
      color: var(--success);
    }

    .cep-status.error {
      color: var(--danger);
    }

    .cep-wrapper .form-input-simple {
      padding-right: 90px;
    }

    .form-input-simple[readonly] {
      background: var(--gray-100);
      cursor: not-allowed;
    }

    .form-input-simple[readonly]:focus {
      border-color: var(--gray-300);
      box-shadow: none;
    }

    @keyframes spin {
      0% { transform: translateY(-50%) rotate(0deg); }
      100% { transform: translateY(-50%) rotate(360deg); }
    }

    .cep-status.loading::after {
      content: "";
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid var(--primary);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-left: 6px;
      vertical-align: middle;
    }
  </style>
</head>

<body>
  <div id="login">
    <div class="login-left">
      <div>
        <h1>Rota Certa</h1>
        <p>Gerencie suas vendas, controle seus gastos e maximize seus lucros de forma simples e eficiente.</p>
      </div>
    </div>
    <div class="login-right">
      <div class="login-card">
        <div class="login-logo">
          <div class="login-logo-icon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
            </svg>
          </div>
          <h1>Rota Certa</h1>
        </div>

        <div class="login-title">
          <h2>Bem-vindo de volta</h2>
          <p>Entre com suas credenciais para continuar</p>
        </div>

        <form onsubmit="login(event)">
          <div class="form-group">
            <label for="email">Email</label>
            <div class="input-wrapper">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
              </svg>
              <input type="email" id="email" class="form-input" placeholder="seu@email.com">
            </div>
          </div>

          <div class="form-group">
            <label for="senha">Senha</label>
            <div class="input-wrapper">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
              </svg>
              <input type="password" id="senha" class="form-input" placeholder="Digite sua senha">
            </div>
          </div>

          <div class="checkbox-wrapper">
            <input type="checkbox" id="mostrarSenha">
            <label for="mostrarSenha">Mostrar senha</label>
          </div>

          <button type="submit" class="btn btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
            </svg>
            Entrar
          </button>
        </form>

        <div id="register" class="hidden" style="margin-top: 12px;">
          <h3 style="text-align:center; margin-bottom:12px;">Criar conta</h3>
          <form onsubmit="criarUsuario(event)">
            <div class="form-group">
              <label for="nome">Nome</label>
              <input id="nome" class="form-input" placeholder="Seu nome completo">
            </div>
            <div class="form-group">
              <label for="emailRegister">Email</label>
              <input type="email" id="emailRegister" class="form-input" placeholder="seu@email.com">
            </div>
            <div class="form-group">
              <label for="senhaRegister">Senha</label>
              <input type="password" id="senhaRegister" class="form-input" placeholder="Digite uma senha">
            </div>
            <div class="form-group">
              <label for="telefoneRegister">Telefone</label>
              <input type="text" id="telefoneRegister" class="form-input" placeholder="(00) 90000-0000" maxlength="15">
            </div>
            <div class="form-group">
              <label for="cepRegister">CEP</label>
              <input id="cepRegister" class="form-input" placeholder="00000-000" maxlength="9">
            </div>
            <div style="display:flex; gap:8px;">
              <button type="submit" class="btn btn-success">Criar conta</button>
              <button type="button" class="btn btn-danger" onclick="toggleRegister(false)">Cancelar</button>
            </div>
          </form>
        </div>

        <div style="text-align:center; margin-top:12px;">
          <a href="#" onclick="toggleRegister(true)">Não possui conta? Crie uma</a>
        </div>
        <div class="forgot-link">
          <a href="#" onclick="alert('Funcionalidade em desenvolvimento')">Esqueceu sua senha?</a>
        </div>
      </div>
    </div>
  </div>

  <div id="app">
    <header class="app-header">
      <div class="header-content">
        <div class="header-logo">
          <div class="header-logo-icon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
            </svg>
          </div>
          <span>Rota Certa</span>
        </div>
        <div class="header-user">
          <div class="user-avatar" id="userAvatar">U</div>
          <button class="btn-logout" onclick="sair()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
            Sair
          </button>
        </div>
      </div>
    </header>

    <main class="app-content">
      <div class="summary-cards">
        <div class="summary-card">
          <div class="summary-card-header">
            <div class="summary-card-icon green">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
          </div>
          <div class="summary-card-title">Total de Ganhos</div>
          <div class="summary-card-value positive" id="totalGanhos">R$ 0,00</div>
        </div>

        <div class="summary-card">
          <div class="summary-card-header">
            <div class="summary-card-icon red">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
              </svg>
            </div>
          </div>
          <div class="summary-card-title">Total de Gastos</div>
          <div class="summary-card-value negative" id="totalGastos">R$ 0,00</div>
        </div>

        <div class="summary-card">
          <div class="summary-card-header">
            <div class="summary-card-icon blue">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
            </div>
          </div>
          <div class="summary-card-title">Lucro Atual</div>
          <div class="summary-card-value" id="totalLucro">R$ 0,00</div>
        </div>
      </div>

      <div class="tabs">
        <button id="tabRegistro" class="tab-btn active" onclick="aba('registro')">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
          </svg>
          Novo Registro
        </button>
        <button id="tabHistorico" class="tab-btn" onclick="aba('historico')">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Historico
        </button>
      </div>

      <div id="registro" class="card">
        <h2 class="card-title">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          Registrar Venda ou Coleta
        </h2>

        <form onsubmit="salvar(event)">
          <div class="form-row">
            <div class="form-group">
              <label>CEP</label>
              <div class="cep-wrapper">
                <input type="text" id="cep" class="form-input-simple" placeholder="00000-000" maxlength="9">
                <div id="cepStatus" class="cep-status"></div>
              </div>
            </div>
            <div class="form-group">
              <label>Data</label>
              <input type="date" id="data" class="form-input-simple">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Logradouro</label>
              <input type="text" id="logradouro" class="form-input-simple" placeholder="Preenchido automaticamente" readonly>
            </div>
            <div class="form-group">
              <label>Bairro</label>
              <input type="text" id="bairro" class="form-input-simple" placeholder="Preenchido automaticamente" readonly>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Gasto com Combustivel (R$)</label>
              <input type="text" id="combustivel" class="form-input-simple money-input" placeholder="R$ 0,00" inputmode="numeric">
            </div>
            <div class="form-group">
              <label>Valor Vendido/Coletado (R$)</label>
              <input type="text" id="valor" class="form-input-simple money-input" placeholder="R$ 0,00" inputmode="numeric">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Servico</label>
              <input list="servicosList" id="servicoInput" class="form-input-simple" placeholder="Digite ou selecione um serviço">
              <datalist id="servicosList"></datalist>
            </div>
            <div class="form-group">
              <label>Quantidade</label>
              <input type="number" id="quantidade" class="form-input-simple" value="1" min="1">
            </div>
            <div class="form-group">
              <label>Nº</label>
              <input type="text" id="numero" class="form-input-simple" placeholder="Número do local">
            </div>
          </div>

          <div class="form-group">
              <label>Tipo de Registro</label>
              <input list="tipoList" id="tipoInput" class="form-input-simple" placeholder="Venda">
              <datalist id="tipoList"><option value="Venda"><option value="Coleta de oleo"></datalist>
            </div>

          <button type="submit" class="btn btn-success" style="margin-top: 8px;">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            Salvar Registro
          </button>
        </form>
      </div>

      <div id="historico" class="card hidden">
        <h2 class="card-title">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Historico de Registros
        </h2>
        <div id="lista" class="timeline"></div>
      </div>
    </main>
  </div>

  <script>
    const senhaInput = document.getElementById('senha');
    const mostrarSenha = document.getElementById('mostrarSenha');

    mostrarSenha.addEventListener('change', (e) => {
      senhaInput.type = e.target.checked ? 'text' : 'password';
    });

    function toggleRegister(show) {
      document.getElementById('register').classList.toggle('hidden', !show);
      document.querySelector('form[onsubmit="login(event)"]')?.classList.toggle('hidden', show);
    }

    function formatarMoedaInput(valor) {
      const numero = valor.replace(/\D/g, '');
      const valorNumerico = parseInt(numero || '0', 10) / 100;
      return valorNumerico.toLocaleString('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      });
    }

    function parseMoeda(valor) {
      const numero = valor.replace(/\D/g, '');
      return parseInt(numero || '0', 10) / 100;
    }

    function aplicarMascaraMoeda(input) {
      input.addEventListener('input', (e) => {
        const cursorPos = e.target.selectionStart;
        const oldLength = e.target.value.length;
        e.target.value = formatarMoedaInput(e.target.value);
        const newLength = e.target.value.length;
        const newPos = cursorPos + (newLength - oldLength);
        e.target.setSelectionRange(newPos, newPos);
      });

      input.addEventListener('focus', (e) => {
        if (!e.target.value || e.target.value === 'R$ 0,00') {
          e.target.value = '';
        }
      });

      input.addEventListener('blur', (e) => {
        if (!e.target.value) {
          e.target.value = 'R$ 0,00';
        } else {
          e.target.value = formatarMoedaInput(e.target.value);
        }
      });
    }

    let modoManualEndereco = false;
    let ultimoCepBuscado = '';

    function formatarCEP(valor) {
      const numero = valor.replace(/\D/g, '');
      if (numero.length <= 5) {
        return numero;
      }
      return numero.slice(0, 5) + '-' + numero.slice(5, 8);
    }

    function aplicarMascaraTelefone(input) {
      input.addEventListener('input', (e) => {
        const raw = e.target.value.replace(/\D/g, '');
        let formatted = raw;
        if (raw.length <= 2) {
          formatted = raw;
        } else if (raw.length <= 6) {
          formatted = `(${raw.slice(0,2)}) ${raw.slice(2)}`;
        } else if (raw.length <= 10) {
          formatted = `(${raw.slice(0,2)}) ${raw.slice(2,6)}-${raw.slice(6)}`;
        } else {
          formatted = `(${raw.slice(0,2)}) ${raw.slice(2,7)}-${raw.slice(7,11)}`;
        }
        e.target.value = formatted;
      });
    }

    function aplicarMascaraCEP(input) {
      input.addEventListener('input', (e) => {
        e.target.value = formatarCEP(e.target.value);
        
        const cepLimpo = e.target.value.replace(/\D/g, '');
        
        if (cepLimpo.length === 8 && cepLimpo !== ultimoCepBuscado) {
          buscarCEP(cepLimpo);
        } else if (cepLimpo.length < 8) {
          const statusEl = document.getElementById('cepStatus');
          statusEl.textContent = '';
          statusEl.className = 'cep-status';
        }
      });
    }

    async function buscarCEP(cep) {
      const statusEl = document.getElementById('cepStatus');
      const bairroInput = document.getElementById('bairro');
      const logradouroInput = document.getElementById('logradouro');

      ultimoCepBuscado = cep;
      statusEl.textContent = 'Buscando...';
      statusEl.className = 'cep-status loading';

      try {
        const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
        const data = await response.json();

        if (data.erro) {
          statusEl.textContent = 'CEP invalido';
          statusEl.className = 'cep-status error';
          habilitarEdicaoManual();
          return;
        }

        modoManualEndereco = false;
        bairroInput.value = data.bairro || '';
        logradouroInput.value = data.logradouro || '';
        
        if (data.bairro) {
          bairroInput.setAttribute('readonly', true);
          bairroInput.placeholder = 'Preenchido automaticamente';
        } else {
          bairroInput.removeAttribute('readonly');
          bairroInput.placeholder = 'Digite o bairro';
        }
        
        if (data.logradouro) {
          logradouroInput.setAttribute('readonly', true);
          logradouroInput.placeholder = 'Preenchido automaticamente';
        } else {
          logradouroInput.removeAttribute('readonly');
          logradouroInput.placeholder = 'Digite o logradouro';
        }

        statusEl.textContent = 'Encontrado!';
        statusEl.className = 'cep-status success';

        setTimeout(() => {
          statusEl.textContent = '';
          statusEl.className = 'cep-status';
        }, 2000);

      } catch (error) {
        console.error('Erro ao buscar CEP:', error);
        statusEl.textContent = 'Erro na busca';
        statusEl.className = 'cep-status error';
        habilitarEdicaoManual();
      }
    }

    function habilitarEdicaoManual() {
      const bairroInput = document.getElementById('bairro');
      const logradouroInput = document.getElementById('logradouro');
      
      modoManualEndereco = true;
      bairroInput.removeAttribute('readonly');
      logradouroInput.removeAttribute('readonly');
      bairroInput.placeholder = 'Digite manualmente';
      logradouroInput.placeholder = 'Digite manualmente';
    }

    function limparFormularioEndereco() {
      const bairroInput = document.getElementById('bairro');
      const logradouroInput = document.getElementById('logradouro');
      const cepInput = document.getElementById('cep');
      const statusEl = document.getElementById('cepStatus');
      
      cepInput.value = '';
      bairroInput.value = '';
      logradouroInput.value = '';
      bairroInput.setAttribute('readonly', true);
      logradouroInput.setAttribute('readonly', true);
      bairroInput.placeholder = 'Preenchido automaticamente';
      logradouroInput.placeholder = 'Preenchido automaticamente';
      statusEl.textContent = '';
      statusEl.className = 'cep-status';
      modoManualEndereco = false;
      ultimoCepBuscado = '';
    }

    const API_URL_DEFAULT = 'http://localhost:3000'; // fallback se não conseguir consultar /config
    let API_URL = API_URL_DEFAULT;

    async function loadApiConfig() {
      // tenta pegar configuração de forma mais amigável: primeiro rota relativa (quando frontend servido pelo backend)
      try {
        let resp = await fetch('/config');
        if (!resp.ok) {
          // tenta com fallback direta no default
          resp = await fetch(`${API_URL_DEFAULT}/config`).catch(()=>null);
        }
        if (resp && resp.ok) {
          const cfg = await resp.json();
          if (cfg && cfg.apiUrl) API_URL = cfg.apiUrl;
        }
      } catch (err) {
        // ignora e mantém API_URL Default
        console.warn('Não foi possível carregar /config do backend, utilizando API_URL default', err);
      }
    }

    function getAuthHeaders() {
      const headers = { 'Content-Type': 'application/json' };
      const token = localStorage.getItem('token');
      if (token) headers['Authorization'] = `Bearer ${token}`;
      return headers;
    }

    async function login(e) {
      if (e) e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const senha = document.getElementById('senha').value.trim();

      if (!email || !senha) {
        alert('Preencha todos os campos para entrar.');
        return;
      }

      // realizar chamada de login para backend
      try {
        const resp = await fetch(`${API_URL}/entrar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, senha })
        });
        if (!resp.ok) {
          const err = await resp.json().catch(()=>({mensagem:'Erro desconhecido'}));
          throw new Error(err.mensagem || 'Falha no login');
        }
        const data = await resp.json();
        localStorage.setItem('token', data.token);
      } catch (error) {
        console.error('Erro login', error);
        if (error.message && (error.message.includes('Failed to fetch') || error.message.includes('NetworkError') || error.message.includes('NetworkErrorWhenAttemptingToFetchResource'))) {
          alert('Não foi possível conectar ao backend em ' + API_URL + '. Verifique se o servidor está em execução.');
        } else {
          alert('Falha no login: ' + (error.message || error));
        }
        return;
      }

      const initial = email.charAt(0).toUpperCase();
      document.getElementById('userAvatar').textContent = initial;

      document.getElementById('login').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      carregar();
    }

    async function criarUsuario(e) {
      if (e) e.preventDefault();
      const nome = document.getElementById('nome').value.trim();
      const email = document.getElementById('emailRegister').value.trim();
      const senha = document.getElementById('senhaRegister').value.trim();
      const telefone = document.getElementById('telefoneRegister').value.trim();
      const cidade = document.getElementById('cepRegister').value.trim();

      if (!nome || !email || !senha) {
        alert('Nome, email e senha são obrigatórios.');
        return;
      }

      try {
        const resp = await fetch(`${API_URL}/criar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ usuario: nome, email: email, senha: senha, telefone: telefone ? telefone.replace(/\D/g, '') : null, cidade: cidade || null })
        });
        if (!resp.ok) {
          const err = await resp.json().catch(()=>({mensagem:'Erro desconhecido'}));
          throw new Error(err.mensagem || 'Erro ao criar usuário');
        }
        const data = await resp.json();
        if (data.token) localStorage.setItem('token', data.token);
        alert('Usuário criado com sucesso! Você foi logado.');
        toggleRegister(false);
        document.getElementById('userAvatar').textContent = nome.charAt(0).toUpperCase();
        document.getElementById('login').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        carregar();
      } catch (error) {
        console.error('Erro criar usuario', error);
        if (error.message && (error.message.includes('Failed to fetch') || error.message.includes('NetworkError'))) {
          alert('Não foi possível conectar ao backend em ' + API_URL + '. Verifique se o servidor está em execução.');
        } else {
          alert('Erro ao criar usuário: ' + (error.message || error));
        }
      }
    }

    function sair() {
      document.getElementById('app').style.display = 'none';
      document.getElementById('login').style.display = 'flex';
      document.getElementById('email').value = '';
      document.getElementById('senha').value = '';
      localStorage.removeItem('token');
    }

    function aba(nome) {
      document.getElementById('registro').classList.toggle('hidden', nome !== 'registro');
      document.getElementById('historico').classList.toggle('hidden', nome !== 'historico');
      document.getElementById('tabRegistro').classList.toggle('active', nome === 'registro');
      document.getElementById('tabHistorico').classList.toggle('active', nome === 'historico');

      if (nome === 'historico') carregar();
    }

    async function salvar(e) {
      if (e) e.preventDefault();
      
      const cep = document.getElementById('cep').value;
      const bairro = document.getElementById('bairro').value;
      const logradouro = document.getElementById('logradouro').value;
      const data = document.getElementById('data').value;
      const combustivelStr = document.getElementById('combustivel').value;
      const valorStr = document.getElementById('valor').value;
      
      const servicoValue = document.getElementById('servicoInput').value.trim();
      const servicoId = servicosByName[servicoValue] || 0;
      const quantidade = parseInt(document.getElementById('quantidade').value || '1');
      const numero = document.getElementById('numero').value || null;
      const tipo = document.getElementById('tipoInput').value;
      const combustivelVal = parseMoeda(combustivelStr);
      const valorTotal = parseMoeda(valorStr);

      if (!servicoId) {
        alert('Selecione um serviço antes de salvar a venda.');
        return;
      }

      const vendaPayload = {
        id_servico: servicoId || null,
        cep: cep,
        bairro: bairro,
        logradouro: logradouro,
        numero: numero,
        quantidade: quantidade,
        valor_total: valorTotal
      };

      if (!cep || !data) {
        alert('Preencha o CEP e a data para continuar.');
        return;
      }

      // enviar para backend
      try {
        const resp = await fetch(`${API_URL}/vendas`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify(vendaPayload)
        });
        if (!resp.ok) {
          const err = await resp.json().catch(()=>({mensagem:'Erro ao salvar'}));
          throw new Error(err.mensagem || 'Erro ao salvar venda');
        }
        const resultado = await resp.json();
        // salvar dados complementares na storage local (tipo e combustivel)
        const registrosExtras = JSON.parse(localStorage.getItem('registros_extras') || '{}');
        registrosExtras[resultado.id] = { combustivel: combustivelVal, tipo: tipo };
        localStorage.setItem('registros_extras', JSON.stringify(registrosExtras));
        alert('Registro salvo com sucesso!');
      } catch (error) {
        console.error('Erro ao salvar venda', error);
        alert('Erro ao salvar registro: ' + (error.message || error) + '\nSalvando localmente...');
        // salva localmente caso o backend esteja indisponível
        try {
          const registros = JSON.parse(localStorage.getItem('registros') || '[]');
          const localId = Date.now();
          registros.push({ id: localId, cep: cep, bairro: bairro, logradouro: logradouro, data: data, valor: valorTotal, combustivel: combustivelVal, tipo: tipo });
          localStorage.setItem('registros', JSON.stringify(registros));
          const registrosExtras = JSON.parse(localStorage.getItem('registros_extras') || '{}');
          registrosExtras['local_' + localId] = { combustivel: combustivelVal, tipo: tipo };
          localStorage.setItem('registros_extras', JSON.stringify(registrosExtras));
        } catch (errLocal) {
          console.error('Erro ao salvar localmente', errLocal);
        }
      }
      limparFormularioEndereco();
      document.getElementById('combustivel').value = 'R$ 0,00';
      document.getElementById('valor').value = 'R$ 0,00';
      carregar();
    }

    function formatarMoeda(valor) {
      return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function formatarData(dataStr) {
      const [ano, mes, dia] = dataStr.split('-');
      return `${dia}/${mes}/${ano}`;
    }

    async function carregar() {
      const registrosExtras = JSON.parse(localStorage.getItem('registros_extras') || '{}');
      let registros = [];
      try {
        const resp = await fetch(`${API_URL}/vendas` , { headers: getAuthHeaders() });
        if (!resp.ok) throw new Error('Erro ao buscar vendas');
        registros = await resp.json();
        if (!Array.isArray(registros)) registros = [];
      } catch (error) {
        console.error('Erro ao carregar vendas', error);
        registros = [];
      }

      // se não houver vendas no servidor, utiliza registros locais antigos
      if (!registros || registros.length === 0) {
        const locais = JSON.parse(localStorage.getItem('registros') || '[]');
        if (Array.isArray(locais) && locais.length > 0) {
          registros = locais.map(r => ({
            id: 'local_' + (r.id || Date.now()),
            id_servico: null,
            cep: r.cep,
            bairro: r.bairro,
            logradouro: r.logradouro,
            numero: null,
            quantidade: 1,
            valor_total: r.valor || 0,
            data: r.data,
            __combustivel: r.combustivel || 0,
            __tipo: r.tipo || 'Venda'
          }));
        }
      }
      const lista = document.getElementById('lista');

      let ganhos = 0;
      let gastos = 0;

      registros.forEach(r => {
        const valor = parseFloat(r.valor_total || 0);
        ganhos += isNaN(valor) ? 0 : valor;
        // procurar combustivel salvo localmente por venda
        const extra = registrosExtras[r.id];
        gastos += extra ? (extra.combustivel || 0) : 0;
      });

      const lucro = ganhos - gastos;

      document.getElementById('totalGanhos').textContent = formatarMoeda(ganhos);
      document.getElementById('totalGastos').textContent = formatarMoeda(gastos);
      
      const lucroEl = document.getElementById('totalLucro');
      lucroEl.textContent = formatarMoeda(lucro);
      lucroEl.className = 'summary-card-value ' + (lucro >= 0 ? 'positive' : 'negative');

      // o backend usa data_venda; vamos ordenar por data_venda
      registros.sort((a, b) => new Date(b.data_venda || b.data) - new Date(a.data_venda || a.data));

      if (registros.length === 0) {
        lista.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
            <h3>Nenhum registro ainda</h3>
            <p>Comece adicionando sua primeira venda ou coleta.</p>
          </div>
        `;
        return;
      }

      lista.innerHTML = registros.map(r => {
        const extra = registrosExtras[r.id] || {};
        const tipo = extra.tipo || r.__tipo || 'Venda';
        const combustivel = extra.combustivel || r.__combustivel || 0;
        const valor = parseFloat(r.valor_total || 0);
        const data = r.data_venda ? r.data_venda.split('T')[0] : (r.data || '');
        return `
        <div class="timeline-item">
          <div class="timeline-icon ${tipo === 'Venda' ? 'venda' : 'coleta'}">
            ${tipo === 'Venda' 
              ? '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>'
              : '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>'
            }
          </div>
          <div class="timeline-content">
            <div class="timeline-header">
              <span class="timeline-title">${tipo} ${servicosMap && servicosMap[r.id_servico] ? '- ' + servicosMap[r.id_servico].nome : ''}</span>
              <span style="display:flex; gap:8px; align-items:center;">
                <span class="timeline-date">${formatarData(data)}</span>
                <button class="btn btn-primary" style="padding:6px 10px; font-size:0.8rem; margin-left:8px;" onclick="editarVenda('${r.id}')">Editar</button>
                <button class="btn btn-danger" style="padding:6px 10px; font-size:0.8rem; margin-left:8px;" onclick="deletarVenda('${r.id}')">Excluir</button>
                ${r.id_servico ? `<button class="btn btn-primary" style="padding:6px 10px; font-size:0.8rem; margin-left:8px;" onclick="editarServico(${r.id_servico})">Editar Serviço</button>` : ''}
                ${r.id_servico ? `<button class="btn btn-danger" style="padding:6px 10px; font-size:0.8rem; margin-left:8px;" onclick="deletarServico(${r.id_servico})">Excluir Serviço</button>` : ''}
              </span>
            </div>
            <div class="timeline-location">${r.logradouro ? r.logradouro + ', ' : ''}${r.bairro || 'Sem bairro'}${r.numero ? ' - Nº ' + r.numero : ''}</div>
            <div class="timeline-values">
              <span class="timeline-value expense">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                </svg>
                ${formatarMoeda(combustivel || 0)}
              </span>
              <span class="timeline-value income">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                </svg>
                ${formatarMoeda(valor || 0)}
              </span>
            </div>
          </div>
          <div id="editArea-${r.id}" class="hidden" style="margin-top:8px;"></div>
        </div>
      `}).join('');

      // ensure that existing edit areas are hidden initially
      registros.forEach(r => {
        const editArea = document.getElementById(`editArea-${r.id}`);
        if (editArea) editArea.classList.add('hidden');
      });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const hoje = new Date().toISOString().split('T')[0];
      document.getElementById('data').value = hoje;

      const combustivelInput = document.getElementById('combustivel');
      const valorInput = document.getElementById('valor');
      const cepInput = document.getElementById('cep');
      const cepRegisterInput = document.getElementById('cepRegister');
      const telefoneRegisterInput = document.getElementById('telefoneRegister');

      aplicarMascaraMoeda(combustivelInput);
      aplicarMascaraMoeda(valorInput);
      aplicarMascaraCEP(cepInput);
      if (cepRegisterInput) aplicarMascaraCEP(cepRegisterInput);
      if (telefoneRegisterInput) aplicarMascaraTelefone(telefoneRegisterInput);

      combustivelInput.value = 'R$ 0,00';
      valorInput.value = 'R$ 0,00';
      await loadApiConfig();
      carregar();
      carregarServicos();
    });

    let servicosMap = {};
    let servicosByName = {};
    async function carregarServicos() {
      const datalist = document.getElementById('servicosList');
      try {
        const resp = await fetch(`${API_URL}/servicos`, { headers: getAuthHeaders() });
        if (!resp.ok) throw new Error('Erro ao buscar servicos');
        const servicos = await resp.json();
        servicosMap = {};
        servicosByName = {};
        datalist.innerHTML = '';
        servicos.forEach(s => {
          servicosMap[s.id] = s;
          servicosByName[s.nome] = s.id;
          datalist.innerHTML += `<option value="${s.nome}"></option>`;
        });
      } catch (error) {
        console.error('Erro ao carregar servicos', error);
        datalist.innerHTML = `<option value="">Não foi possível carregar serviços</option>`;
      }
    }

    async function editarVenda(id) {
      try {
        let venda;
        if (String(id).startsWith('local_')) {
          // local storage
          const locais = JSON.parse(localStorage.getItem('registros') || '[]');
          venda = locais.find(x => 'local_' + x.id === id);
          if (!venda) {
            alert('Registro local não encontrado');
            return;
          }
          venda.id = id; // keep local id format
        } else {
          const resp = await fetch(`${API_URL}/vendas/${id}`, { headers: getAuthHeaders() });
          if (!resp.ok) throw new Error('Não foi possível obter a venda');
          venda = await resp.json();
        }
        showEditArea(id, venda);
      } catch (error) {
        console.error('Erro ao editar venda', error);
        alert('Erro ao carregar dados para edição: ' + (error.message || error));
      }
    }

    async function editarServico(id) {
      try {
        const resp = await fetch(`${API_URL}/servicos/${id}`, { headers: getAuthHeaders() });
        if (!resp.ok) throw new Error('Não foi possível buscar o serviço');
        const servico = await resp.json();
        const novoNome = prompt('Nome do serviço:', servico.nome || '');
        if (novoNome === null) return;
        const novoPreco = prompt('Preço médio (ex: 12.50):', servico.preco_medio || '');
        if (novoPreco === null) return;
        const payload = { id_motorista: servico.id_motorista || null, nome: novoNome, preco_medio: parseFloat(novoPreco) || 0, descricao: servico.descricao || '' };
        const resp2 = await fetch(`${API_URL}/servicos/${id}`, { method: 'PUT', headers: getAuthHeaders(), body: JSON.stringify(payload) });
        if (!resp2.ok) throw new Error('Erro ao atualizar serviço');
        alert('Serviço atualizado com sucesso');
        carregarServicos();
        carregar();
      } catch (error) {
        console.error('Erro editarServico', error);
        alert('Erro ao editar serviço: ' + (error.message || error));
      }
    }

    async function deletarServico(id) {
      if (!confirm('Deseja deletar este serviço? Isso pode afetar vendas existentes.')) return;
      try {
        const resp = await fetch(`${API_URL}/servicos/${id}`, { method: 'DELETE', headers: getAuthHeaders() });
        if (!resp.ok) throw new Error('Erro ao deletar serviço');
        alert('Serviço deletado');
        carregarServicos();
        carregar();
      } catch (error) {
        console.error('Erro deletarServico', error);
        alert('Erro ao deletar serviço: ' + (error.message || error));
      }
    }

    function showEditArea(id, venda) {
      const editArea = document.getElementById(`editArea-${id}`);
      if (!editArea) return;
      editArea.classList.remove('hidden');
      // build a small inline form
      const servicoName = servicosMap && servicosMap[venda.id_servico] ? servicosMap[venda.id_servico].nome : '';
      const combustivelExtra = (JSON.parse(localStorage.getItem('registros_extras') || '{}'))[venda.id] ? (JSON.parse(localStorage.getItem('registros_extras') || '{}'))[venda.id].combustivel : (venda.__combustivel || 0);
      editArea.innerHTML = `
        <div class="card" style="padding:12px;">
          <div style="display:grid; gap:8px; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));">
            <div><label>CEP</label><input id="editCep_${id}" class="form-input-simple" value="${venda.cep || ''}"></div>
            <div><label>Logradouro</label><input id="editLog_${id}" class="form-input-simple" value="${venda.logradouro || ''}"></div>
            <div><label>Bairro</label><input id="editBairro_${id}" class="form-input-simple" value="${venda.bairro || ''}"></div>
            <div><label>Número</label><input id="editNumero_${id}" class="form-input-simple" value="${venda.numero || ''}"></div>
            <div><label>Serviço</label><input list="servicosList" id="editServico_${id}" class="form-input-simple" value="${servicoName}"></div>
            <div><label>Quantidade</label><input id="editQtd_${id}" type="number" min="1" class="form-input-simple" value="${venda.quantidade || 1}"></div>
            <div><label>Valor R$</label><input id="editValor_${id}" class="form-input-simple" value="${formatarMoeda(parseFloat(venda.valor_total || 0))}"></div>
            <div><label>Combustível R$</label><input id="editComb_${id}" class="form-input-simple" value="${formatarMoeda(combustivelExtra || 0)}"></div>
          </div>
          <div style="display:flex; gap:8px; margin-top:8px;">
            <button class="btn btn-success" onclick="salvarEdicao('${id}')">Salvar</button>
            <button class="btn btn-danger" onclick="cancelarEdicao('${id}')">Cancelar</button>
          </div>
        </div>
      `;
      // apply masks
      aplicarMascaraCEP(document.getElementById(`editCep_${id}`));
      aplicarMascaraMoeda(document.getElementById(`editValor_${id}`));
      aplicarMascaraMoeda(document.getElementById(`editComb_${id}`));
    }

    function cancelarEdicao(id) {
      const editArea = document.getElementById(`editArea-${id}`);
      if (!editArea) return;
      editArea.classList.add('hidden');
      editArea.innerHTML = '';
    }

    async function salvarEdicao(id) {
      try {
        const cep = document.getElementById(`editCep_${id}`).value;
        const logradouro = document.getElementById(`editLog_${id}`).value;
        const bairro = document.getElementById(`editBairro_${id}`).value;
        const numero = document.getElementById(`editNumero_${id}`).value;
        const servicoName = document.getElementById(`editServico_${id}`).value.trim();
        const quantidade = parseInt(document.getElementById(`editQtd_${id}`).value || '1');
        const valor = parseMoeda(document.getElementById(`editValor_${id}`).value);
        const combustivel = parseMoeda(document.getElementById(`editComb_${id}`).value);
        const id_servico = servicosByName[servicoName] || null;
        if (!id_servico) {
          alert('Escolha um serviço válido da lista antes de salvar.');
          return;
        }

        if (String(id).startsWith('local_')) {
          // update local storage
          const locais = JSON.parse(localStorage.getItem('registros') || '[]');
          const index = locais.findIndex(x => 'local_' + x.id === id);
          if (index === -1) throw new Error('Registro local não encontrado');
          locais[index].cep = cep;
          locais[index].logradouro = logradouro;
          locais[index].bairro = bairro;
          locais[index].numero = numero;
          locais[index].valor = valor;
          locais[index].quantidade = quantidade;
          localStorage.setItem('registros', JSON.stringify(locais));
          const registrosExtras = JSON.parse(localStorage.getItem('registros_extras') || '{}');
          registrosExtras[id] = { combustivel: combustivel, tipo: 'Venda' };
          localStorage.setItem('registros_extras', JSON.stringify(registrosExtras));
          cancelarEdicao(id);
          carregar();
          return;
        }

        const payload = { id_servico: id_servico, cep: cep, bairro: bairro, logradouro: logradouro, numero: numero, quantidade: quantidade, valor_total: valor };
        const resp = await fetch(`${API_URL}/vendas/${id}`, { method: 'PUT', headers: getAuthHeaders(), body: JSON.stringify(payload) });
        if (!resp.ok) {
          const err = await resp.json().catch(()=>({mensagem:'Erro desconhecido'}));
          throw new Error(err.mensagem || 'Erro ao salvar edição');
        }
        // update local extra
        const registrosExtras = JSON.parse(localStorage.getItem('registros_extras') || '{}');
        registrosExtras[id] = { combustivel: combustivel, tipo: 'Venda' };
        localStorage.setItem('registros_extras', JSON.stringify(registrosExtras));
        cancelarEdicao(id);
        carregar();
      } catch (error) {
        console.error('Erro ao salvar edição', error);
        alert('Erro ao salvar edição: ' + (error.message || error));
      }
    }

    async function deletarVenda(id) {
      if (!confirm('Deseja realmente excluir este registro?')) return;
      try {
        if (String(id).startsWith('local_')) {
          const locais = JSON.parse(localStorage.getItem('registros') || '[]');
          const index = locais.findIndex(x => 'local_' + x.id === id);
          if (index >= 0) locais.splice(index, 1);
          localStorage.setItem('registros', JSON.stringify(locais));
          const registrosExtras = JSON.parse(localStorage.getItem('registros_extras') || '{}');
          delete registrosExtras[id];
          localStorage.setItem('registros_extras', JSON.stringify(registrosExtras));
          carregar();
          return;
        }
        const resp = await fetch(`${API_URL}/vendas/${id}`, { method: 'DELETE', headers: getAuthHeaders() });
        if (!resp.ok) {
          const err = await resp.json().catch(()=>({mensagem:'Erro desconhecido'}));
          throw new Error(err.mensagem || 'Erro ao excluir venda');
        }
        const registrosExtras = JSON.parse(localStorage.getItem('registros_extras') || '{}');
        delete registrosExtras[id];
        localStorage.setItem('registros_extras', JSON.stringify(registrosExtras));
        carregar();
      } catch (error) {
        console.error('Erro ao excluir', error);
        alert('Erro ao excluir: ' + (error.message || error));
      }
    }
  </script>
</body>
</html>
